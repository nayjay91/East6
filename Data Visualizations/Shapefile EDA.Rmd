---
title: "Visualization EDA"
author: "Nathan Miller"
date: "11/30/2021"
output: html_document
---


```{r, warning=F, message=F}
library(sf)
library(ggmap)
library(leaflet)
library(dplyr)

census <- st_read("Data/2010_CensusData/2010_CensusData.shp") 
abandoned_properties <- st_read("Data/Abandoned_Property_Parcels/Abandoned_Property_Parcels.shp")
city_council_dist <- st_read("Data/City_Council_Districts/City_Council_Districts.shp")
school_boundaries <- st_read("Data/School_Boundaries/School_Boundaries.shp")

contacts_311_df <- read.csv("Data/311_Contact_Management_Cases.csv")

logs_311_df <- read.csv("Data/311_Phone_Call_Log_Mod.csv")

#311 files do not contain geographical information. 

business_licenses_df <- read.csv("Data/Business_Licenses_geocoded.csv")%>% 
  st_as_sf(coords = c("X","Y"))

#business licenses uses x/y instead of lat/lon

parks_df <- read.csv("Data/Parks_Locations_and_Features.csv") %>% 
  st_as_sf(coords = c("Lon","Lat"))

public_facilities_df <- read.csv("Data/Public_Facilities.csv") %>% 
  st_as_sf(coords = c("Lon","Lat"))

street_lights_df <- read.csv("Data/Street_lights.csv") %>% 
  st_as_sf(coords = c("Lon","Lat"))
```

```{r}
### Add Var names to relevant Census columns 
census <- census %>% 
  dplyr::rename(Population = SE_T001_00,
                age_u5 = SE_T008_02,
                age_5_9 = SE_T008_03,
                age_11_14 = SE_T008_04,
                age_15_17 = SE_T008_05,
                age_18_24 = SE_T008_06,
                age_25_34 = SE_T008_07,
                age_35_44 = SE_T008_08,
                age_45_54 = SE_T008_09,
                age_55_64 = SE_T008_10,
                age_65_74 = SE_T008_11,
                age_75_84 = SE_T008_12,
                occupied_houses = SE_T069_01, 
                owner_occupied = SE_T069_02) %>% 
  dplyr::mutate(renter_occupied = occupied_houses - owner_occupied)

```


# business licenses groupings
```{r}
#### Categorize Business Data 
food <- c('RESTAURANTS A-M', 
          'RESTAURANTS N-Z',
          'FOOD VENDING MACHINES', #may want to remove
          'FOOD VENDING VEHICLES', #may want to remove
          'ITINERANT RESTAURANT', #may want to remove
          'MOBILE FOOD TRUCK' #may want to remove
          ) 

retail <- c('OPEN AIR VENDORS PRIVATE',
             'OPEN AIR VENDORS PUBLIC',
             'SECOND HAND DEALERS',
             'PRECIOUS METAL DEALERS',
             'PET SHOPS',
             'TRANSIENT MERCHANT XMAS TREE', #may want to remove
             'TRANSIENT MERCHANT', #may want to remove
             'PEDDLER & CANVASSER'
             )

service <- c('ARBORIST/TREE SERVICE',
            'MASSAGE THERAPY',
            'MASSAGE ESTABLISHMENT',
            'TATTOO AND BODY PIERCING ESTABLISHMENTS',
            'AUTOMOTIVE REPAIR & SVC',
            'MECHANICAL LICENSE',
            'TATTOO AND PIERCING ARTIST',
            'VEHICLE REMOVAL',
            'ALARM AGENT',
            'RUBBISH & GARBAGE REMOVAL',
            'SELF SERVICE LAUNDRY',
            'HOTEL/MOTEL', #could make this a separate category
            'SCRAP METAL /JUNK DEALERS' #included here because generally these are used by people looking to get rid of stuff, not purchase like in retail
            )

entertainment <- c('ADULT BUSINESS',
            'PERFORMING ANIMAL EXHIBITIONS',
            'BUSKER OR SIDEWALK PERFORMER',
            'OUTDOOR MOVIE THEATRE',
            'POOL HALLS')

transportation <- c('TAXI DRIVER',
                    'TAXI VEHICLE',
                    'TAXI COMPANY',
                    'PUBLIC PARKING FACILITY',
                    'LAWN PARK 10 OR MORE SPACES',
                    'LAWN PARK UNDER 10 SPACES') #may want to exclude this category entirely

charitable <- c('CHARITABLE SOLICITATIONS',
                'DONATION BOXES AND CONTAINERS') #may want to exclude this category entirely

#'unclassified' check for categorization, anything not included in above categories are unclassified. Remove entire categories we might want to be unclassified. 

unclassified <- unique(business_licenses_df$Classifi_1) %>% 
  as_tibble() %>% 
  filter(!value %in% c(food, retail, service, entertainment, transportation, charitable))

business_licenses_df <- business_licenses_df %>% 
  mutate(business_type = case_when(Classifi_1 %in% food ~ 'Food',
                                 Classifi_1 %in% retail ~ 'Retail',
                                 Classifi_1 %in% service ~ 'Service',
                                 Classifi_1 %in% entertainment ~ 'Entertainment',
                                 TRUE ~ 'Unclassified')
         )

table(business_licenses_df$business_type)
```


```{r}
pal_business <- colorFactor(palette = 'Set2', domain = business_licenses_df$Classifi_1)
business_licenses_df$popup <- paste("<b>",business_licenses_df$Business_N,"</b><br>",
                                  "Type: ",business_licenses_df$Classifi_1,sep ="")

leaflet()  %>%
  addTiles()  %>%
  addCircleMarkers(data = business_licenses_df,popup = ~popup,  color = ~pal_business(Classifi_1), stroke = 0, fillOpacity = 1, radius = 4) 
```
# Abandoned Properties

```{r}
View(abandoned_properties)
```

```{r}

#did not finish this section
pal_abandoned <- colorFactor(palette = 'Set2', domain = abandoned_properties$Outcome_St)
business_licenses_df$popup <- paste("<b>",business_licenses_df$Business_N,"</b><br>",
                                  "Type: ",business_licenses_df$Classifi_1,sep ="")

leaflet()  %>%
  addTiles()  %>%
  addCircleMarkers(data = pal_abandoned,popup = ~popup,  color = ~pal_business(Classifi_1), stroke = 0, fillOpacity = 1, radius = 4)
```

# Census data to disctricts
```{r}


# Convert Census CRS to WGS84
census_transformed <- census %>% 
  select(geometry, GEOID, Population) %>% # Add relevant census metrics... 
  st_transform(crs = st_crs(city_council_dist)) %>% 
  mutate(c_area = units::drop_units(st_area(.))) #what are the units for area?
  
sf::sf_use_s2(FALSE) # reformat CRS to fix?? 
# Set Buffer = 0 to fix city council topology
city_council_dist2 <- sf::st_buffer(city_council_dist, dist = 0)
sf::sf_use_s2(TRUE)


intrsct <- sf::st_intersection(city_council_dist2, census_transformed) %>% 
  mutate(in_area = units::drop_units(st_area(.))) %>% 
  ### Calc proportional census data based on area of intersection 
  mutate(pop = Population * in_area / c_area) %>% 
  group_by(OBJECTID, Dist, Council_Me) %>% 
  summarise(pop = sum(pop),
            pop_density = sum(pop)/sum(in_area)) %>% 
  ungroup()

```

```{r}
ggplot() +
    geom_sf(data = intrsct, aes(fill = pop_density), alpha = .5, lwd = .25) +
    scale_fill_gradient(trans = "log10", 
                        low = "white",
                        high = "firebrick",
                        labels = scales::comma_format())
```
# Business License Locations 
```{r}



# Give business data same CRS as intersection 
st_crs(business_licenses_df) <- st_crs(intrsct)

# Businesses inside of council districts 
bus_in_district_sf <- st_join(business_licenses_df, city_council_dist2, join = st_intersects) %>% 
  dplyr::select(License_Ye, Business_N, Street_Add, Business_P, business_type, OBJECTID, Dist, Council_Me) %>% 
  filter(is.na(Council_Me) == FALSE)

# convert from sf to tibble to aggregate 
bus_in_distric_df <- bus_in_district_sf %>% 
  tibble() %>% 
  group_by(Dist, Council_Me, business_type) %>% 
  summarise(n = n())

```

```{r}
ggplot(data = bus_in_distric_df, aes(x = n, y = business_type)) +
  geom_col() +
  facet_grid(~Council_Me)

```


```{r}

#intr <- sf::st_intersection(city_council_dist2, census_transformed)
leaflet() %>% 
  addTiles() %>% 
  #addPolygons(data = census) %>% 
  #addPolygons(data = city_council_dist, color = 'red') %>% 
  addPolygons(data = intr, color = 'black') #%>% 
  # addMarkers(data = bus_in_district_sf) ### DONT RUN UNTIL CATEGORIES ARE FILTERED

```






