---
title: "Visualization EDA"
author: "Nathan Miller"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=F, message=F}
library(sf)
library(ggmap)
library(leaflet)
library(dplyr)

census <- st_read("Data/2010_CensusData/2010_CensusData.shp") 
abandoned_properties <- st_read("Data/Abandoned_Property_Parcels/Abandoned_Property_Parcels.shp")
city_council_dist <- st_read("Data/City_Council_Districts/City_Council_Districts.shp")
school_boundaries <- st_read("Data/School_Boundaries/School_Boundaries.shp")

contacts_311_df <- read.csv("Data/311_Contact_Management_Cases.csv")

logs_311_df <- read.csv("Data/311_Phone_Call_Log_Mod.csv")

#311 files do not contain geographical information. 

business_licenses_df <- read.csv("Data/Business_Licenses_geocoded.csv")%>% 
  st_as_sf(coords = c("X","Y"))

#business licenses uses x/y instead of lat/lon

parks_df <- read.csv("Data/Parks_Locations_and_Features.csv") %>% 
  st_as_sf(coords = c("Lon","Lat"))

public_facilities_df <- read.csv("Data/Public_Facilities.csv") %>% 
  st_as_sf(coords = c("Lon","Lat"))

street_lights_df <- read.csv("Data/Street_lights.csv") %>% 
  st_as_sf(coords = c("Lon","Lat"))
```


# business licenses
```{r}
table(business_licenses_df$Classifi_1)
#maybe we should consider some way of categorizing and redusing the number of businesses classified here. Could have a selection pane for each type of business license. 
#food
#shopping
#entertainment
#service
```


```{r}
pal_business <- colorFactor(palette = 'Set2', domain = business_licenses_df$Classifi_1)
business_licenses_df$popup <- paste("<b>",business_licenses_df$Business_N,"</b><br>",
                                  "Type: ",business_licenses_df$Classifi_1,sep ="")

leaflet()  %>%
  addTiles()  %>%
  addCircleMarkers(data = business_licenses_df,popup = ~popup,  color = ~pal_business(Classifi_1), stroke = 0, fillOpacity = 1, radius = 4) 
```
# Abandoned Properties

```{r}
View(abandoned_properties)
```

```{r}

#did not finish this section
pal_abandoned <- colorFactor(palette = 'Set2', domain = abandoned_properties$Outcome_St)
business_licenses_df$popup <- paste("<b>",business_licenses_df$Business_N,"</b><br>",
                                  "Type: ",business_licenses_df$Classifi_1,sep ="")

leaflet()  %>%
  addTiles()  %>%
  addCircleMarkers(data = pal_abandoned,popup = ~popup,  color = ~pal_business(Classifi_1), stroke = 0, fillOpacity = 1, radius = 4)
```

```{r}
leaflet() %>% 
  addTiles() %>% 
  addPolygons(data = census) %>% 
  addPolygons(data = city_council_dist, color = 'red')
```

```{r}

# Convert Census CRS to WGS84
census_transformed <- census %>% 
  select(geometry, GEOID, ALAND, SE_T001_00) %>% # Add relevant census metrics... 
  st_transform(crs = st_crs(city_council_dist))


sf::sf_use_s2(FALSE) # reformat CRS to fix?? 
# Set Buffer = 0 to fix city council topology
city_council_dist2 <- sf::st_buffer(city_council_dist, dist = 0)
sf::sf_use_s2(TRUE)


intrsct <- sf::st_intersection(city_council_dist2, census_transformed) %>% 
  mutate(in_area = units::drop_units(st_area(.))) %>% 
  ### Calc proportional census data based on area of intersection 
  mutate(pop = SE_T001_00 * in_area / ALAND) %>% 
  group_by(OBJECTID, Dist, Council_Me) %>% 
  summarise(pop = sum(pop))
  
```

```{r}
ggplot() +
    geom_sf(data = intrsct, aes(fill = pop), alpha = .5, lwd = .25) +
    scale_fill_gradient(trans = "log10", 
                        low = "white",
                        high = "firebrick",
                        labels = scales::comma_format())
```







