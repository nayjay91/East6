---
title: "Final Project Part 2"
author: "Nathan Miller, Eli Schultz, Shannon Takahata"
date: "11/26/2021"
output: html_document
---

# East 6

# Introduction

Airport executives and state and local officials are curious about customer satisfaction at San Francisco International Airport.Identifying current strengths of the airport and areas for improvement are critical to increasing traffic and revenue.

A survey was administered to 3,234 participants in September 2010 and contains 100 different variables. The results contain two identifiers and mostly nominal and ordinal categorical variables. Nominal responses are for questions on topics such as airline, services used, comments grouped into areas of improvement or positive feedback, destination, and more. Ordinal responses cover levels of satisfaction on various areas or services, ease of use, and size of destination airport. A few binned numeric responses are also included, such as income, age, destination airport size, and time of flight. The only continuous variable is the weight assigned to each response by percent of passengers by terminal.

# Part A

## Data Wrangling 

```{r, echo=FALSE, message= FALSE}
library(dplyr)
library(tidyverse)
library(stringr)
library(purrr)
library(naniar)
library(magrittr)
library(readr)
```

```{r, echo=FALSE}
SFOdata <-read.table("SFO_survey_withText.txt", header = TRUE, sep = "", quote = "\"", dec = ".", fill = TRUE, comment.char = "",strip.white=TRUE,stringsAsFactors = default.stringsAsFactors())

UsefulWebFeatures <- read.csv("UsefulWebFeatures.csv")
CommentForImprovement <- read.csv("Comment_For_Improvement.csv")
```

```{r}
oldnames = c("Q6A",
             "Q6B",
             "Q6C",
             "Q6D",
             "Q6E",
             "Q6F",
             "Q6G",
             "Q6H",
             "Q6I",
             "Q6J",
             "Q6K",
             "Q6L",
             "Q6M",
             "Q6N",
             "Q7COM1",
             "Q7COM2",
             "Q7COM3",
             "Q8A",
             "Q8B",
             "Q8C",
             "Q8D",
             "Q8E",
             "Q8F",
             "Q9",
             "Q10",
             "Q11",
             "Q11A1",
             "Q11A2",
             "Q11A3",
             "Q17",
             "Q18",
             "Q19",
             "DESTMARK",
             "DESTGEO",
             "Q7_text_All")
newnames = c("Artwork_and_exihibits_0_6",
             "Restaurants_0_6",
             "Retail_shops_0_6",
             "Signs_and_directions_inside_SFO_0_6",
             "Escalators_elevators_moving_walkways_0_6",
             "Information_on_screen_monitors_0_6",
             "Information_booths_lower_level_0_6",
             "Information_booths_upper_level_0_6",
             "Signs_and_directsion_on_roadways_0_6",
             "Airport_parking_facilities_0_6",
             "AirTrain_0_6",
             "Long_term_parking_lot_shuttle_0_6",
             "Airport_rental_car_center_0_6",
             "CFO_Airport_as_a_whole_0_6",
             "Com_For_Improve1",
             "Com_For_Improve2",
             "Com_For_Improve3",
             "Cleanliness_Boarding_area_0_6",
             "Cleanliness_Parking_Garage_0_6",
             "Cleanliness_Airtrain_0_6",
             "Cleanliness_Airport_rental_car_center_0_6",
             "Cleanliness_Airport_Restaurants_0_6",
             "Cleanliness_Restrooms_0_6",
             "Safety_of_SFO_1_5",
             "Used_website",
             "Usefulness_of_website",
             "Com_Useful_feature_of_website_1",
             "Com_Useful_feature_of_website_2",
             "Com_Useful_feature_of_website_3",
             "Age",
             "Gender",
             "Income_code",
             "Destination_Market",
             "Destination_Geo_Loc",
             "Comments_For_Improvement_Txt")

## Rename and recode comments for improvements and web features
SelectedData <- SFOdata %>% 
  rename_at(vars(all_of(oldnames)), ~ newnames) %>% 
  select(all_of(newnames), RESPNUM) %>% 
  left_join(CommentForImprovement, by = c("Com_For_Improve1" = "Key")) %>% 
  mutate(Com_For_Improve1 = CommentForImprovement) %>% 
  select(-CommentForImprovement) %>% 
  left_join(CommentForImprovement, by = c("Com_For_Improve2" = "Key")) %>% 
  mutate(Com_For_Improve2 = CommentForImprovement) %>% 
  select(-CommentForImprovement) %>% 
  left_join(CommentForImprovement, by = c("Com_For_Improve3" = "Key")) %>% 
  mutate(Com_For_Improve3 = CommentForImprovement) %>% 
  select(-CommentForImprovement) %>% 
  left_join(UsefulWebFeatures, by = c("Com_Useful_feature_of_website_1" = "key")) %>% 
  mutate(Com_Useful_feature_of_website_1 = WebFeature) %>% 
  select(-WebFeature) %>% 
  left_join(UsefulWebFeatures, by = c("Com_Useful_feature_of_website_2" = "key")) %>% 
  mutate(Com_Useful_feature_of_website_2 = WebFeature) %>% 
  select(-WebFeature) %>% 
  left_join(UsefulWebFeatures, by = c("Com_Useful_feature_of_website_3" = "key")) %>% 
  mutate(Com_Useful_feature_of_website_3 = WebFeature) %>% 
  select(-WebFeature) %>% 
  mutate(Gender = ifelse(Gender == 0, NA, Gender - 1))
```

Encode missing data

```{r}
missing_encoded <- SelectedData %>% 
  select(-starts_with("Com_"),-Usefulness_of_website) %>% 
#  mutate_at( vars(ends_with("0_6")),~as.factor(.)) %>% 
  mutate_at( vars(ends_with("0_6")),~car::recode(.,"6= NA;0= NA")) 
```

```{r}
glimpse(missing_encoded)
glimpse(SelectedData)
```

MAY NEED TO DO THIS Addressing missing data The clustering process has remove NA's as a step. This removed about 1000 rows. We would likely need to create values for all variables though, and it seemed like mice filed in the y variable based on the multiple x's.

```{r,echo=FALSE, message= FALSE}
library(psych)
library(mice)
```

Created a subset of data with the overall customer satisfaction scores and the demographic variables.

```{r}
q1 <- missing_encoded %>% 
  select(Age, 
         Income_code, 
         Gender, 
         CFO_Airport_as_a_whole_0_6)
```

Created subset with overall customer satisfaction and satisfaction of the other airport aspects.

```{r}
q2 <- missing_encoded %>% 
  select(Artwork_and_exihibits_0_6,
         Restaurants_0_6,
         Retail_shops_0_6,
         Signs_and_directions_inside_SFO_0_6,
         Escalators_elevators_moving_walkways_0_6,
         Information_on_screen_monitors_0_6,
         Information_booths_lower_level_0_6,
         Information_booths_upper_level_0_6,
         Signs_and_directsion_on_roadways_0_6,
         Airport_parking_facilities_0_6,
         AirTrain_0_6,
         Long_term_parking_lot_shuttle_0_6,
         Airport_rental_car_center_0_6, 
         CFO_Airport_as_a_whole_0_6)
```

Created subset with customer satisfaction and comments

```{r}
q3 <- SFOdata %>% select(RESPNUM,Q7_text_All)
```

## Question 1

Customers were asked to rate their opinion of the "SFO Airport as a whole" on a scale from 1 ("unacceptable") to 5 ("outstanding"). The executives want to know if there are patterns across the satisfied or dissatisfied customers based on demographic characteristics, such as sex, age group, and income level.

We can see how the individual demographics (age, income, gender) relate to the overall satisfaction through plotting the individual demographics. To determine if there are patterns across the level of satisfaction based on demographic characteristics, we can use clustering for our analysis so that we can see how the different customers are grouped. 

Clustering allows us to combine the different demographics and then group similar objects together. Cluster models assign observations based on the distance of a central point (such as the mean). Since our data has variables that contain a mean (since the responses are based on a scale of 1-5), we can use the mean as the center of our cluster. We can use this unsupervised machine learning method to identify the observations to find the different categories of the SFO customers.


First, we understand the trends of each individual demographic.

1. Age: From the histogram, the age group 25-34 filled out the most survey. Ratings of 4 were the most prevalent across all age groups.
```{r}
ggplot(data = q1,aes(x=as.factor(Age), fill = as.factor(CFO_Airport_as_a_whole_0_6))) +
  geom_bar(aes(y = ..count../sum(..count..))) + xlab("Age")+scale_x_discrete(labels=c("Under 18","18-24","25-34","35-44","45-54","55-64","65 and older","Don't know/refused")) +ylab("Proportion") +ggtitle("Satisfaction by Age")+ scale_fill_discrete(name = "Satisfaction")+theme(axis.text.x = element_text(angle=45))
```

2. Gender: From the histogram, more males completed the surveys than females. Both rated the airport as 4 the most.
```{r}
ggplot(data = q1,aes(x=as.factor(Gender), fill = as.factor(CFO_Airport_as_a_whole_0_6))) +
  geom_bar(aes(y = ..count../sum(..count..))) + xlab("Gender") +ylab("Proportion")+scale_x_discrete(labels=c("Male","Female")) +ggtitle("Satisfaction by Gender")+ scale_fill_discrete(name = "Satisfaction")
```

3. Income: From the histogram, those with an income of $50,000 to $100,000 completed the survey. All income groups rated the airport as 4 the most.
```{r}
ggplot(data = q1,aes(x=as.factor(Income_code), fill = as.factor(CFO_Airport_as_a_whole_0_6))) +
  geom_bar(aes(y = ..count../sum(..count..))) + xlab("Income") +ylab("Proportion")+scale_x_discrete(labels = c("Under $50k","$50k-$100k","$100k-$150k","Over 150k","Other")) +ggtitle("Satisfaction by Income")+ scale_fill_discrete(name = "Satisfaction")
```

Next, we identify any patterns across all demographics. 
```{r,echo=FALSE, message= FALSE}
library(factoextra)
library(cluster)
library(mclust)
library(tidyverse)
library(NbClust)
library(lavaan)
```

We must determine how many clusters to use. This number is the number of groups that the different objects will be grouped in. We see from the graph below to use 4 groups.
```{r}
q1 %>% 
  scale() %>% 
  na.omit() %>% 
  fviz_nbclust(x = ., FUNcluster = kmeans, method = "gap")
```

We used the kmeans test, where the different groups are formed by the closest observations to the mean of the cluster. This test does not respond well to outliers. However, since the data is based on 5 discrete responses, there will not be any outliers.

```{r}
kmeansTest <-  kmeans(x = scale(na.omit(q1)), centers = 4)

fviz_cluster(kmeansTest, scale(na.omit(q1)))
```

We can view the values of the centers of the clusters.
```{r}
kmeansTest$centers
```

However, these centers are scaled. We look at the unscaled centers for further analysis.

```{r}
usedData <-  q1 %>%
  na.omit() %>% 
  scale()

kmeansCenters <- as.data.frame(kmeansTest$centers)

varNames <-  names(kmeansCenters)

unscaleCenters <-  function(varName) {
  unscaled = kmeansCenters[, varName] * 
    attr(x = usedData, which = "scaled:scale")[varName] + 
    attr(x = usedData, which = "scaled:center")[varName]  
  
  res = data.frame(unscaled)
  
  names(res) = varName
  
  return(res)
}

clusterCentersRaw <-  lapply(varNames, function(x) unscaleCenters(x)) %>% 
  bind_cols(.)
clusterCentersRaw %>% 
 mutate_if(is.numeric, round, digits = 2)
```

We see that the clusters demonstrate that there is a pattern across satisfied and dissatisfied customers based on demographic characteristics.  
Cluster 1: 35-44, Around 75k, female, highly positive 
Cluster 2: 44-55, Around 150k, female, satisfactory 
Cluster 3: 25-35, Around 75k, male, highly positive 
Cluster 4: 45-54, Around 150k, male, satisfactory

## Question 2

The executives also want to know if customer satisfaction can be broken down into different attributes of the airport. Knowing this will help the team target specific strengths or areas of improvement. The central feature the customer satisfaction survey is a 14-question portion of the survey asking customers to rate satisfaction with different aspects of the airport (see Question 6 in the data directory). The executives want you to perform a quantitative analysis to determine if there are broad themes that emerge from this part of the survey.

To determine how customers rated each individual aspect of the airport, we can plot the airport aspect with the customer satisfaction. To determine if there are any broad themes, we used factor analysis.

Factor analysis is when we explain the covariance or correlation among the variables. Factors represent some underlying construct of satisfaction. The factors are unobservable variables that can reduce the number of observed variables. 
```{r,echo=FALSE, message= FALSE}
library(psych)
library(lavaan)
library(ggcorrplot)
```

The customer satisfaction by each individual airport aspect can be seen as the following. We see that the highest ratings are 3s and 4s for most of the airport aspects. 
```{r}
q2 %>% pivot_longer(cols = ends_with("0_6")) %>%
#na.omit() %>%
mutate(value = ifelse(value == 6, NA, value)) %>%
ggplot(aes(x=as.factor(value))) +
geom_histogram(stat = 'count') +
facet_wrap(~name, nrow = 4) +
xlab('Rating')
```

We then perform factor analysis to identify and analyze the latent variables. However, we first determine if factor analysis can be performed on this data set.
```{r}
cortest.bartlett(q2)
```

```{r}
KMO(q2)
```

We see that the p value from the barlett test is very small, so we reject the null hypothesis that the variables are not correlated. The overall MSA is greater that 0.6. Therefore, it makes sense to perform factor analysis to combine the variables.

We determine the number of factors. There are three triangles between the red lines and so we select 3 factors.
```{r}
psych::fa.parallel(q2)
```

```{r}
scree(q2)
```

We will use 3 factors moving forward.We then fit the model with oblique rotation since we want factrs that are correlated.
```{r}
x3 <- fa(r = q2, nfactors = 3, rotate = "promax")
x3
```

The first factor is related to restaurants, artwork, signs, escalations, and information booth. This could be associated with satisfaction with signs and visual information. 

The second factor is related to roadways, parking, rental car, and airtrain. This could be associated with satisfaction with parking and transportation. 

The last factor relates to artwork, restaurants, and retail. This could be associated with the retail aspects of the airport.

```{r}
dat_loads <- x3$loadings
dat_loads
```

```{r}
scores <- factor.scores(q2,x3,method=c("Thurstone"))
summary(scores$scores)
```

## Question 3

Free-response comments, either positive or negative, were collected in addition to the 14-item quantitative survey. The executives are not quite sure how to examine it without going through individual surveys one by one, but they want you to see if there are any concepts or insights that arise from these responses. Do the free responses relate to the findings in a) or b) at all?

We will develop a sentiment analysis model to determines the overall sentiment of a document by comparing positive and negative words. Since the comments are text based fields, we can look at the specific model of the comments to determine the overall sentiment. 

For more specific analysis, we will develop a topic model. Topics models define the topics within a document. Combining all the comments regarding customers' overall satisfaction, our analysis determines the topics.

```{r,echo=FALSE, message= FALSE}
library(tidytext)
library(sentimentr)
library(textdata)
library(wordcloud)
library(wordcloud2)
library(stm)
library(tm)
```

We see that there are more negative comments that positive comments in our sentiment model.
```{r}
comments <- q3 %>% 
  unnest_tokens(word, Q7_text_All)
comments  %>%
    inner_join(get_sentiments("nrc")) %>%
    count(sentiment, sort = TRUE)
comments %>%
      inner_join(get_sentiments("bing")) %>%
      count(sentiment, sort = TRUE)
```


### Topic Model
In choosing the number of topics, we focus on a high semantic coherence (how well the words hang together) and low residuals. We choose 20 topics based on the graphs.
```{r}
custom_stop_words <- c("General", 
                       "positive", 
                       "negative",
                       "comments", 
                       "about", 
                       "SFO",
                       "airport",
                       "Airlines",
                       "neg",
                       "comment")

df_text <- textProcessor(documents = q3$Q7_text_All, 
                           metadata = missing_encoded, 
                           onlycharacter = TRUE,
                           customstopwords = c(tm::stopwords("SMART"), 
                                               tm::stopwords("en"),
                                               custom_stop_words))

df_Prep <-  prepDocuments(documents = df_text$documents, 
                               vocab = df_text$vocab,
                               meta = df_text$meta)

kTest <- searchK(documents = df_Prep$documents, 
             vocab = df_Prep$vocab, 
             K = c(3, 5, 10, 20, 35),
             verbose = F,
             max.em.its = 200)

plot(kTest)
```
```{r}
topics <-  stm(documents = df_Prep$documents, 
             vocab = df_Prep$vocab, 
             K = 5, #change this to whatever the plot shows best
             verbose = F,
             max.em.its = 200)
```

The plot and the labels represent the different topics from the comments.
```{r}
plot(topics)
labelTopics(topics)
```


# Part B
Do particular groups of passengers have more trouble with signage (one of the most commented issue areas) than others? i.e can accessibility be improved by identifying and targeting improvements for at risk groups. Possible variables to investigate: "Age", "Gender", "Income_code", "Destination_Market", "Destination_Geo_Loc"

